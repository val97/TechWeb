var MongoClient = require('mongodb').MongoClient;
var url_DBass = "mongodb://localhost:27017/DBass";
var url_DBrel = "mongodb://localhost:27017/DBrel";
var url = "mongodb://localhost:27017/";
var debug=true;

reset();
insert_ass("pippo3");
findOne_ass("pippo");
find_ass(2);
insert_rel("pippo1","pippo2");
insert_rel("pippo1","pippo2");
insert_rel("pippo1","pippo3");
find_rel("pippo2",2);


function reset(){		//resetta tutto (non so se sia effettivamente necessario usarlo)

	MongoClient.connect(url_DBass, function(err, db) {
		if (err) throw err;
		if(debug) console.log("Database ass created!");
		db.close();
	});
	MongoClient.connect(url_DBrel, function(err, db) {
		if (err) throw err;
		if(debug) console.log("Database rel created!");
		db.close();
	});
	
	MongoClient.connect(url, function(err, db) {
		if (err) throw err;
		var dbo = db.db("DBass");
		dbo.createCollection("ass", function(err, res) {
			if (err) throw err;
			if(debug) console.log("Collection assolute created!");
		});
		
		db.close();
	});
	MongoClient.connect(url, function(err, db) {
  		if (err) throw err;
  		var dbo = db.db("DBass");
  		dbo.collection("ass").deleteMany({}, function(err, obj) {
    			if (err) throw err;
    			console.log(obj.result.n + " document(s) deleted");
    			db.close();
  		});
	});
};
function insert_ass(vid_id){			//salva la visualizzazione del video vid_id
	MongoClient.connect(url, function(err, db) {
		if (err) throw err;
  		var dbo = db.db("DBass");
		dbo.collection("ass").findOne({id: vid_id},{}, function(err, result) {		//{id: "id del video in questione",
			if (err) throw err;							// num: "numero visualizzazioni"}
			if(result==null){
				if(debug) console.log("video non esistente");
				var video = {id:vid_id, num: 1}
				dbo.collection("ass").insertOne(video, function(err, res) {
					if (err) throw err;
					
				});

			}else{
				var myquery = {id:vid_id}
				var newvalues = { $set: {num: result.num+1} };
				dbo.collection("ass").updateOne(myquery, newvalues, function(err, res) {
					if (err) throw err;
					if(debug) console.log("1 document updated");
				
				});
			}
			if(debug) console.log(result);
			db.close();
		});
		/*setTimeout(function() {
			
		}, 1000);*/
	});
	
};
function insert_rel(from_id,to_id){			//salva la visualizzazione del video to_id, dopo aver visto from_id
	MongoClient.connect(url, function(err, db) {
		if (err) throw err;
  		var dbo = db.db("DBrel");
		dbo.collection(from_id).findOne({id: to_id},{}, function(err, result) {		//{id: "id del video in questione",
			if (err) throw err;							// num: "numero visualizzazioni"}
			if(result==null){
				if(debug) console.log("video non esistente");
				var video = {id:to_id, num: 1}
				dbo.collection(from_id).insertOne(video, function(err, res) {
					if (err) throw err;
					
				});

			}else{
				var myquery = {id:to_id}
				var newvalues = { $set: {num: result.num+1} };
				dbo.collection(from_id).updateOne(myquery, newvalues, function(err, res) {
					if (err) throw err;
					if(debug) console.log("1 document updated");
				
				});
			}
			if(debug) console.log(result);
			db.close();
		});
		
	});
	
};

function findOne_ass(vid_id){				//per debug, trova numero di visualizzazioni di vid_id
	MongoClient.connect(url, function(err, db) {
		if (err) throw err;
  		var dbo = db.db("DBass");
		dbo.collection("ass").findOne({id: vid_id},{}, function(err, result) {		//{id: "id del video in questione",
			if (err) throw err;							// num: "numero visualizzazioni"}
			if(debug) console.log(result);
			db.close();
		});
	});
	
};
function find_ass(n){				//trova gli n video piu visualizzati
	MongoClient.connect(url, function(err, db) {
		if (err) throw err;
  		var dbo = db.db("DBass");
		dbo.collection("ass").find().sort({num:-1}).limit(n).toArray(function(err,result){
			if (err) throw err;
			if(debug) console.log("find_ass:");
    			if(debug) console.log(result);
			
    			db.close();
		});
	});
	
};
function find_rel(from_id,n){			//trova gli n video piu visualizzati dopo aver visualizzato from_id
	MongoClient.connect(url, function(err, db) {
		if (err) throw err;
  		var dbo = db.db("DBrel");
		dbo.collection(from_id).find().sort({num:-1}).limit(n).toArray(function(err,result){
			if (err) throw err;
			if(debug) console.log("find_rel:");
    			if(debug) console.log(result);
			
    			db.close();
		});
	});
	
};
